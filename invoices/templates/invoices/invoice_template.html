<!-- templates/invoices/invoice_template.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice {{ invoice.doc_number|default:invoice.qb_invoice_id }}</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #374151;
            line-height: 1.3;
            font-size: 0.8rem;
        }
        
        /* Print Styles */
        @media print {
            @page {
                margin: 0.25in;
                size: letter;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background: white;
                font-size: 0.75rem;
            }
            .no-print {
                display: none !important;
            }
            .break-inside-avoid {
                page-break-inside: avoid;
            }
        }
        
        /* Layout Styles */
        .container {
            max-width: 56rem;
            margin: 0 auto;
        }
        
        .action-buttons {
            padding: 0.5rem 1rem;
        }
        
        .button-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: {{ company.brand_color|default:'#2563eb' }};
            color: white;
        }
        
        .btn-primary:hover {
            background-color: {{ company.brand_color|default:'#2563eb' }};
            filter: brightness(0.9);
        }
        
        .btn-secondary {
            background-color: #4b5563;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #374151;
        }
        
        /* Invoice Container */
        .invoice-container {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        
        /* Header Section */
        .invoice-header {
            padding: 1rem 1.5rem;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .company-info {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            flex: 1;
        }
        
        .company-logo {
            flex-shrink: 0;
        }
        
        .logo-img {
            height: 3rem;
            width: auto;
            object-fit: contain;
        }
        
        .company-details h1 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 0.25rem;
        }
        
        .company-address {
            color: #374151;
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            font-size: 0.7rem;
            color: #4b5563;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
        }
        
        .icon {
            width: 0.875rem;
            height: 0.875rem;
            margin-right: 0.375rem;
        }
        
        /* Header Bottom */
        .header-bottom {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 0.75rem;
        }
        
        .bill-to {
            flex: 1;
        }
        
        .bill-to h2 {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        
        .bill-to-name {
            color: #374151;
            font-size: 0.8rem;
        }
        
        .brand-line {
            height: 0.375rem;
            margin-top: 0.5rem;
            background-color: {{ company.brand_color|default:'#0077C5' }};
        }
        
        .invoice-meta {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
            flex: 1;
        }
        
        .invoice-title {
            background-color: {{ company.brand_color|default:'#0077C5' }};
            color: white;
            padding: 0.375rem 0.75rem;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .date-info {
            background-color: {{ company.brand_color|default:'#0077C5' }};
            color: white;
            padding: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            min-width: 0;
            flex-wrap: nowrap;
            max-width: 100%;
            font-size: 0.7rem;
        }

        .date-info span:first-of-type {
            flex-shrink: 0;
            min-width: 2rem;
        }

        .date-info span:last-of-type {
            min-width: 6rem;
            white-space: nowrap;
            flex-shrink: 1;
        }
        
        /* Products Table */
        .invoice-body {
            padding: 1rem 1.5rem;
        }
        
        .table-container {
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }
        
        thead tr {
            background-color: {{ company.brand_color|default:'#0077C5' }};
            color: white;
        }
        
        th {
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-right: 1px solid #d1d5db;
        }
        
        th:last-child {
            border-right: none;
        }
        
        th.text-center {
            text-align: center;
        }
        
        /* Column widths */
        .col-item { width: 3rem; }
        .col-desc { width: auto; }
        .col-tax { width: 4rem; }
        .col-qty { width: 3rem; }
        .col-price { width: 5rem; }
        .col-amount { width: 5rem; }
        
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        tbody tr:nth-child(odd) {
            background-color: white;
        }
        
        td {
            padding: 0.5rem 0.75rem;
            border-right: 1px solid #d1d5db;
            font-size: 0.7rem;
            line-height: 1.2;
        }
        
        td:last-child {
            border-right: none;
        }
        
        .item-number {
            font-weight: 500;
            color: #111827;
        }
        
        .item-name {
            font-weight: 500;
            color: #111827;
            font-size: 0.7rem;
        }
        
        .item-description {
            color: #4b5563;
            font-size: 0.65rem;
            margin-top: 0.125rem;
            line-height: 1.1;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        /* Totals Section */
        .totals-section {
            display: flex;
            justify-content: flex-end;
            padding-top: 1rem;
            margin-top: 0.75rem;
        }
        
        .totals-container {
            width: 16rem;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 0.375rem 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.7rem;
        }
        
        .total-row:last-child {
            border-bottom: none;
        }
        
        .total-main {
            border-top: 2px solid #9ca3af;
            padding: 0.5rem 0;
        }
        
        .total-due {
            background-color: {{ company.brand_color|default:'#0077C5' }};
            color: white;
            display: flex;
            justify-content: space-between;
            padding: 0.375rem 0.75rem;
            margin-top: 0.375rem;
            font-size: 0.7rem;
        }
        
        .total-label {
            color: #374151;
        }
        
        .total-amount {
            font-weight: 500;
            color: #111827;
        }
        
        .total-main .total-label,
        .total-main .total-amount {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .total-due .total-label,
        .total-due .total-amount {
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }
        
        /* Tax Summary */
        .tax-summary {
            margin-top: 1rem;
            padding-top: 1rem;
        }
        
        .tax-summary h2 {
            font-weight: 600;
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .tax-table {
            font-size: 0.7rem;
        }
        
        .tax-table th {
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 600;
        }
        
        .tax-table td {
            padding: 0.5rem 0.75rem;
            border-top: 1px solid #d1d5db;
        }
        
        /* QR Code Section */
        .qr-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #d1d5db;
        }
        
        .qr-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .qr-code {
            background: white;
            padding: 0.375rem;
            border: 1px solid #d1d5db;
            flex-shrink: 0;
        }
        
        .qr-img {
            width: 4rem;
            height: 4rem;
            display: block;
        }
        
        .qr-info h3 {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        
        .qr-details {
            font-size: 0.65rem;
            color: #4b5563;
            line-height: 1.2;
        }
        
        /* Notes Section */
        .notes-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #d1d5db;
        }
        
        .notes-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .notes-container {
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
            font-size: 0.7rem;
        }
        
        .note-item {
            margin-bottom: 0.5rem;
        }
        
        .note-item:last-child {
            margin-bottom: 0;
        }
        
        .note-label {
            font-size: 0.65rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.125rem;
        }
        
        .note-content {
            color: #111827;
        }
        
        .note-content.internal {
            color: #4b5563;
        }
        
        /* Footer */
        .invoice-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #d1d5db;
        }
        
        .footer-text {
            font-size: 0.65rem;
            color: #4b5563;
            text-align: center;
        }
        
        /* Utility Classes */
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.7rem; }
        .text-lg { font-size: 0.8rem; }
        .text-xl { font-size: 0.9rem; }
        .text-2xl { font-size: 1rem; }
        
        /* Currency formatting */
        .currency-symbol {
            font-weight: 600;
        }

        /* Compact row styling */
        .compact-row {
            min-height: 1.5rem;
        }

        /* Ultra compact mode */
        .table-ultra-compact th,
        .table-ultra-compact td {
            padding: 0.375rem 0.5rem;
            font-size: 0.65rem;
        }

        .table-ultra-compact .item-name {
            font-size: 0.65rem;
        }

        /* Debug styles */
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            font-size: 0.7rem;
        }
    </style>
</head>
<body>
    <!-- Debug info - remove in production -->
    <div class="no-print debug-info">
        <h4>Debug Info:</h4>
        <p>Company: {{ company.name }}</p>
        <p>Brand Color: {{ company.brand_color }}</p>
        <p>KRA Submission: {{ kra_submission }}</p>
        <p>QR Code Data: {{ kra_submission.qr_code_data|default:"None" }}</p>
        <p>QR Code Base64: {{ qr_code|yesno:"Present,Not Present" }}</p>
    </div>

    <!-- Action buttons - hidden when printing -->
    <div class="no-print action-buttons">
        <div class="button-group">
            <a href="{% url 'generate_invoice_pdf' invoice.id %}" class="btn btn-primary">
                Download PDF
            </a>
            <button onclick="window.print()" class="btn btn-secondary">
                Print Invoice
            </button>
        </div>
    </div>

    <!-- Invoice Container -->
    <div class="container">
        <div class="invoice-container break-inside-avoid">
            <!-- Header Section -->
            <div class="invoice-header">
                <div class="header-top">
                    <!-- Company Logo and Info -->
                    <div class="company-info">
                        {% if company.custom_logo and company.invoice_logo_enabled %}
                        <div class="company-logo">
                            <img src="{{ company.custom_logo.url }}" 
                                 alt="{{ company.name }} logo" 
                                 class="logo-img">
                        </div>
                        {% elif company.logo_url and company.invoice_logo_enabled %}
                        <div class="company-logo">
                            <img src="{{ company.logo_url }}" 
                                 alt="{{ company.name }} logo" 
                                 class="logo-img"
                                 onerror="this.style.display='none'">
                        </div>
                        {% endif %}
                        
                        <div class="company-details">
                            <h1>{{ company.qb_company_name|default:company.name }}</h1>
                            {% if company.qb_address %}
                            <p class="company-address">
                                {% if company.qb_address.Line1 %}{{ company.qb_address.Line1 }}<br>{% endif %}
                                {% if company.qb_address.Line2 %}{{ company.qb_address.Line2 }}<br>{% endif %}
                                {% if company.qb_address.City %}{{ company.qb_address.City }}, {% endif %}
                                {% if company.qb_address.CountrySubDivisionCode %}{{ company.qb_address.CountrySubDivisionCode }} {% endif %}
                                {% if company.qb_address.PostalCode %}{{ company.qb_address.PostalCode }}{% endif %}
                            </p>
                            {% endif %}
                            
                            <div class="contact-info">
                                {% if company.qb_phone %}
                                <div class="contact-item">
                                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                    <span>{{ company.qb_phone }}</span>
                                </div>
                                {% endif %}
                                
                                {% if company.qb_email %}
                                <div class="contact-item">
                                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    <span>{{ company.qb_email }}</span>
                                </div>
                                {% endif %}
                                
                                {% if company.qb_website %}
                                <div class="contact-item">
                                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9m0 9c-5 0-9-4-9-9s4-9 9-9"/>
                                    </svg>
                                    <span>{{ company.qb_website }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="header-bottom">
                    <!-- Bill To Section -->
                    <div class="bill-to">
                        <h2>BILL TO</h2>
                        <div class="bill-to-name">{{ invoice.customer_name }}</div>
                        <div class="brand-line"></div>
                    </div>

                    <!-- Invoice Header Info -->
                    <div class="invoice-meta">
                        <div class="invoice-title">
                            TAX INVOICE {{ invoice.doc_number|default:invoice.qb_invoice_id }}
                        </div>

                        <div class="date-info">
                            <span>Date:</span>
                            <span>{{ invoice.txn_date|date:"M j, Y" }}</span>
                        </div>

                        {% if invoice.due_date %}
                        <div class="date-info">
                            <span>Due:</span>
                            <span>{{ invoice.due_date|date:"M j, Y" }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Products Table -->
            <div class="invoice-body">
                <div class="table-container {% if invoice.line_items.all|length <= 3 %}table-ultra-compact{% endif %}">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-item">#Item No</th>
                                <th class="col-desc">Description</th>
                                <th class="col-tax text-center">Tax</th>
                                <th class="col-qty text-center">Qty</th>
                                <th class="col-price text-center">Unit Price</th>
                                <th class="col-amount text-center">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in invoice.line_items.all %}
                            <tr class="compact-row">
                                <td>
                                    <span class="item-number">{{ forloop.counter }}</span>
                                </td>
                                <td>
                                    <div>
                                        <div class="item-name">{{ item.item_name }}</div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {{ item.tax_amount|default:0|floatformat:2 }}
                                </td>
                                <td class="text-center">{{ item.qty|floatformat:2 }}</td>
                                <td class="text-center">
                                    {{ item.unit_price|floatformat:2 }}
                                </td>
                                <td class="text-center font-medium">
                                    {{ item.amount|floatformat:2 }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Totals Section -->
                <div class="totals-section">
                    <div class="totals-container">
                        <div class="total-row">
                            <span class="total-label">SUBTOTAL:</span>
                            <span class="total-amount">
                                <span class="currency-symbol">{{ company.currency_code|default:"USD" }}</span>{{ invoice.subtotal|default:invoice.total_amt|floatformat:2 }}
                            </span>
                        </div>
                        
                        <div class="total-row">
                            <span class="total-label">TOTAL TAX:</span>
                            <span class="total-amount">
                                <span class="currency-symbol">{{ company.currency_code|default:"USD" }}</span>{{ invoice.tax_total|default:0|floatformat:2 }}
                            </span>
                        </div>

                        <div class="total-row total-main">
                            <span class="total-label">Total:</span>
                            <span class="total-amount">
                                <span class="currency-symbol">{{ company.currency_code|default:"USD" }}</span>{{ invoice.total_amt|floatformat:2 }}
                            </span>
                        </div>

                        <div class="total-due">
                            <span class="total-label">Total Due:</span>
                            <span class="total-amount">
                                <span class="currency-symbol">{{ company.currency_code|default:"USD" }}</span>{{ invoice.total_amt|floatformat:2 }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Tax Summary -->
                <div class="tax-summary">
                    <h2>TAX SUMMARY</h2>
                    <div class="table-container tax-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>RATE</th>
                                    <th>TAX</th>
                                    <th>NET</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ invoice.tax_percent|default:0|floatformat:2 }}%</td>
                                    <td>
                                        <span class="currency-symbol">{{ company.currency_code|default:"USD" }}</span>{{ invoice.tax_total|default:0|floatformat:2 }}
                                    </td>
                                    <td>
                                        <span class="currency-symbol">{{ company.currency_code|default:"USD" }}</span>{{ invoice.subtotal|default:0|floatformat:2 }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KRA QR Code Section -->
                {% if kra_submission and kra_submission.qr_code_data %}
                <div class="qr-section">
                    <div class="qr-container">
                        <div class="qr-code">
                            {% if qr_code %}
                            <img src="data:image/png;base64,{{ qr_code }}" 
                                alt="KRA QR Code" 
                                class="qr-img">
                            {% else %}
                            <!-- Fallback if QR code generation fails -->
                            <div style="width: 4rem; height: 4rem; background: #f3f4f6; display: flex; align-items: center; justify-content: center; border: 1px dashed #d1d5db;">
                                <span style="font-size: 0.6rem; text-align: center; color: #6b7280;">QR Code<br>Available</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="qr-info">
                            <h3>KRA VALIDATION</h3>
                            <div class="qr-details">
                                Status: <span class="font-semibold" style="color: {% if kra_submission.status == 'success' %}#10b981{% else %}#ef4444{% endif %};">
                                    {{ kra_submission.status|title }}
                                </span><br>
                                Receipt: {{ kra_submission.receipt_signature }}<br>
                                Date: {{ kra_submission.created_at|date:"M j, Y" }}
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <a href="{{ kra_submission.qr_code_data }}" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                style="color: #2563eb; text-decoration: underline; font-size: 0.65rem;">
                                    View KRA Receipt Online
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Debug: Show why QR code isn't displaying -->
                <div class="no-print debug-info">
                    <h4>QR Code Not Available:</h4>
                    <p>KRA Submission: {{ kra_submission|default:"None" }}</p>
                    <p>QR Code Data: {{ kra_submission.qr_code_data|default:"None" }}</p>
                    <p>Status: {{ kra_submission.status|default:"Unknown" }}</p>
                </div>
                {% endif %}

                <!-- Notes Section -->
                {% if invoice.customer_memo or invoice.private_note %}
                <div class="notes-section">
                    <h3 class="notes-title">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Notes
                    </h3>
                    <div class="notes-container">
                        {% if invoice.customer_memo %}
                        <div class="note-item">
                            <div class="note-label">Customer Message:</div>
                            <div class="note-content">{{ invoice.customer_memo }}</div>
                        </div>
                        {% endif %}
                        {% if invoice.private_note %}
                        <div class="note-item">
                            <div class="note-label">Internal Notes:</div>
                            <div class="note-content internal">{{ invoice.private_note }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Footer -->
                {% if company.invoice_footer_text %}
                <div class="invoice-footer">
                    <p class="footer-text">{{ company.invoice_footer_text }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Currency formatting script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const currencyCode = '{{ company.currency_code|default:"USD" }}';
            const currencyElements = document.querySelectorAll('.currency-symbol');
            
            currencyElements.forEach(element => {
                const customSymbols = {
                    'USD': '$',
                    'EUR': '€',
                    'GBP': '£',
                    'JPY': '¥',
                    'KES': 'KSh ',
                    'UGX': 'USh ',
                    'TZS': 'TSh ',
                    'NGN': '₦',
                    'GHS': 'GH₵ ',
                    'ZAR': 'R'
                };
                
                if (customSymbols[currencyCode]) {
                    element.textContent = customSymbols[currencyCode];
                } else {
                    element.textContent = currencyCode + ' ';
                }
            });
        });
    </script>
</body>
</html>